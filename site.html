<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Capivara no Aquático</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/addons/p5.sound.min.js"></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        width: 100%;
      }
      canvas {
        display: block;
      }
      .toast {
        visibility: hidden;
        min-width: 250px;
        background-color: rgba(0, 0, 0, 0.8);
        color: #fff;
        text-align: center;
        border-radius: 4px;
        padding: 12px 20px;
        position: fixed;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        font-size: 14px;
        z-index: 9999;
        transition: visibility 0s, opacity 0.5s ease;
        opacity: 0;
      }

      .toast.show {
        visibility: visible;
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div id="toast" class="toast"></div>

    <script>
      let capivara;
      let capivaraStanding;
      let capivaraAtual;
      let capivaraX;
      let boias = [];
      let pedras = [];
      let fundo;
      let fundoCancun;
      let vidas = 3;
      let tempo = 40;
      let pontos = 0;
      let frameContador = 0;
      let pedraImg, boiaLaranja, boiaAzul;
      let gameOverImg, tryAgainIcon;
      let isMobile = false;
      let arrastando = false;
      let capivaraSurfista;
      let capivaraSurfistaPulando;
      let velocidadeBonus = 0;
      let fundoBaleia, fundoMalibu;
      let capivaraPai, capivaraPaiPulando;
      let capivaraMae, capivaraMaePulando;
      let modoAvancado = false;
      let marco150Ativado = false;
      let marco250Ativado = false;
      let marco350Ativado = false;
      let musicaFundo;
      let lastBackPress = 0;
      let jogoAtivo = true;
      let carregandoImgs = [];
      let indiceImagemCarregando = 0;
      let tempoTrocaImagem = 0;
      let tempoFimCarregamento = 0;
      const TEMPO_MINIMO_CARREGAMENTO = 4000;
      let ultimoTempoAtualizado = 0;
      let carregamentoCompleto = false;

      let imagensParaCarregar = [
        {
          name: "fundo",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/fundo.jpg",
        },
        {
          name: "fundoCancun",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/fundo-cancun.jpg",
        },
        {
          name: "capivara",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/capivara.png",
        },
        {
          name: "capivaraStanding",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/capivara-standing.png",
        },
        {
          name: "capivaraSurfista",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/capivara-surfista.png",
        },
        {
          name: "capivaraSurfistaPulando",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/capivara-surfista-pulando-1.png",
        },
        {
          name: "pedraImg",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/gelo.png",
        },
        {
          name: "boiaLaranja",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/boia_laranja.png",
        },
        {
          name: "boiaAzul",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/boia_azul.png",
        },
        {
          name: "gameOverImg",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/game-over.png",
        },
        {
          name: "tryAgainIcon",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/try-again.svg",
        },
        {
          name: "fundoBaleia",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/fundo-baleia.jpg",
        },
        {
          name: "fundoMalibu",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/fundo-malibu.jpg",
        },
        {
          name: "capivaraPai",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/capivara-pai.png",
        },
        {
          name: "capivaraPaiPulando",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/capivara-pai-pulando.png",
        },
        {
          name: "capivaraMae",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/capivara-mae.png",
        },
        {
          name: "capivaraMaePulando",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/capivara-mae-pulando.png",
        },
        {
          name: "carregando1",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/carregando-1.png",
        },
        {
          name: "carregando2",
          url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/carregando-2.png",
        },
      ];
      let somParaCarregar = {
        name: "musicaFundo",
        url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/Musica-capivaras.mp3",
      };

      let imagensCarregadas = {};
      let totalAssets = imagensParaCarregar.length + 1;
      let assetsCarregados = 0;

      let frases = [
        "Chamando todas as capivaras...",
        "Passando protetor solar...",
        "Ligando as ondas...",
        "Ativando o modo Aquática Turbo...",
        "Prontos para a diversão...",
      ];
      let fraseAtual = 0;
      let tempoFrase = 0;

      function carregarAssets() {
        imagensParaCarregar.forEach((asset) => {
          loadImage(
            asset.url,
            (img) => {
              imagensCarregadas[asset.name] = img;
              if (
                asset.name === "carregando1" ||
                asset.name === "carregando2"
              ) {
                carregandoImgs.push(img);
              }
              assetsCarregados++;
              checarFimCarregamento();
            },
            (err) => {
              console.error(`Erro carregando imagem ${asset.name}`);
              assetsCarregados++;
              checarFimCarregamento();
            }
          );
        });

        loadSound(
          somParaCarregar.url,
          (snd) => {
            musicaFundo = snd;
            assetsCarregados++;
            checarFimCarregamento();
          },
          (err) => {
            console.error("Erro carregando música");
            assetsCarregados++;
            checarFimCarregamento();
          }
        );
      }

      function checarFimCarregamento() {
        if (assetsCarregados >= totalAssets && tempoFimCarregamento === 0) {
          tempoFimCarregamento = millis();
        }
      }

      function iniciarJogo() {
        fundo = imagensCarregadas.fundo;
        fundoCancun = imagensCarregadas.fundoCancun;
        capivara = imagensCarregadas.capivara;
        capivaraStanding = imagensCarregadas.capivaraStanding;
        capivaraSurfista = imagensCarregadas.capivaraSurfista;
        capivaraSurfistaPulando = imagensCarregadas.capivaraSurfistaPulando;
        pedraImg = imagensCarregadas.pedraImg;
        boiaLaranja = imagensCarregadas.boiaLaranja;
        boiaAzul = imagensCarregadas.boiaAzul;
        gameOverImg = imagensCarregadas.gameOverImg;
        tryAgainIcon = imagensCarregadas.tryAgainIcon;
        fundoBaleia = imagensCarregadas.fundoBaleia;
        fundoMalibu = imagensCarregadas.fundoMalibu;
        capivaraPai = imagensCarregadas.capivaraPai;
        capivaraPaiPulando = imagensCarregadas.capivaraPaiPulando;
        capivaraMae = imagensCarregadas.capivaraMae;
        capivaraMaePulando = imagensCarregadas.capivaraMaePulando;
        capivaraAtual = capivara;
        loop();
        if (musicaFundo) {
          musicaFundo.loop();
        }
      }

      function preload() {
        let imagensLoading = [
          {
            name: "carregando1",
            url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/carregando-1.png",
          },
          {
            name: "carregando2",
            url: "https://aquaticaamericanpark.com.br/wp-content/uploads/2025/08/carregando-2.png",
          },
        ];

        imagensLoading.forEach((img) => {
          loadImage(img.url, (loadedImg) => {
            carregandoImgs.push(loadedImg);
          });
        });
      }

      function setup() {
        createCanvas(windowWidth, windowHeight);
        capivaraX = width / 2;
        capivaraAtual = capivara;
        isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        isIphone = /iPhone|iPod/i.test(navigator.userAgent);

        carregarAssets();
        startManualLoop();

        document.addEventListener("touchmove", (e) => e.preventDefault(), {
          passive: false,
        });

        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            if (musicaFundo && musicaFundo.isPlaying()) musicaFundo.pause();
          } else {
            if (musicaFundo && !musicaFundo.isPlaying()) musicaFundo.loop();
          }
        });

        window.onpopstate = function () {
          showToast("Pressione novamente para sair");
          history.pushState(null, null, location.href);
        };
        history.pushState(null, null, location.href);

        startManualLoop();
      }

      function desenharTelaLoading() {
        background("#255370");
        noStroke();

        tempoTrocaImagem++;
        if (tempoTrocaImagem > 60) {
          indiceImagemCarregando =
            (indiceImagemCarregando + 1) % carregandoImgs.length;
          tempoTrocaImagem = 0;
        }

        if (
          carregandoImgs.length > 0 &&
          carregandoImgs[indiceImagemCarregando]
        ) {
          let img = carregandoImgs[indiceImagemCarregando];
          let imgW;
          if (isMobile) {
            imgW = width * 0.6;
          } else {
            imgW = width * 0.3;
          }
          let imgH = imgW * (img.height / img.width);
          image(img, width / 2 - imgW / 2, height / 2 - imgH - 40, imgW, imgH);
        }
        let barraWidth = width * 0.6;
        let barraHeight = 20;
        let xBar = (width - barraWidth) / 2;
        let yBar = height / 2;

        fill("#fff");
        rect(xBar, yBar, barraWidth, barraHeight, 10);

        fill("#e79f3e");
        let progresso = assetsCarregados / totalAssets;
        rect(xBar, yBar, barraWidth * progresso, barraHeight, 10);

        tempoFrase++;
        if (tempoFrase > 120) {
          fraseAtual = (fraseAtual + 1) % frases.length;
          tempoFrase = 0;
        }

        let alpha = map(tempoFrase, 0, 120, 0, 255);
        if (tempoFrase > 60) alpha = map(tempoFrase, 60, 120, 255, 0);
        fill(255, alpha);
        textAlign(CENTER, CENTER);
        textSize(20);
        text(frases[fraseAtual], width / 2, yBar + barraHeight + 30);
      }

      function showToast(message, duration = 3000) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
        }, duration);
      }

      window.onpopstate = function (event) {
        showToast("Pressione novamente para sair");
        history.pushState(null, null, location.href);
      };

      history.pushState(null, null, location.href);

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
        capivaraX = constrain(capivaraX, 0, width);
      }

      function startManualLoop() {
        function frame() {
          draw();
          window.requestAnimationFrame(frame);
        }
        window.requestAnimationFrame(frame);
      }

      function draw() {
        if (assetsCarregados < totalAssets) {
          desenharTelaLoading();
          return;
        }

        if (!carregamentoCompleto) {
          if (millis() - tempoFimCarregamento >= TEMPO_MINIMO_CARREGAMENTO) {
            console.log("Iniciando jogo...");
            carregamentoCompleto = true;
            iniciarJogo();
            loop();
          } else {
            desenharTelaLoading();
            return;
          }
        }

        background(255);
        let imgAspect = fundo.width / fundo.height;
        let canvasAspect = width / height;
        let drawWidth,
          drawHeight,
          offsetX = 0,
          offsetY = 0;
        if (canvasAspect > imgAspect) {
          drawWidth = width;
          drawHeight = width / imgAspect;
          offsetY = (height - drawHeight) / 2;
        } else {
          drawHeight = height;
          drawWidth = height * imgAspect;
          offsetX = (width - drawWidth) / 2;
        }
        let fundoAtual = fundo;
        if (pontos >= 300) fundoAtual = fundoMalibu;
        else if (pontos >= 200) fundoAtual = fundoBaleia;
        else if (pontos >= 100) fundoAtual = fundoCancun;

        image(fundoAtual, offsetX, offsetY, drawWidth, drawHeight);

        velocidadeBonus = jogoAtivo ? Math.floor(pontos / 80) : 0;

        if (!marco150Ativado && pontos >= 100) {
          tempo = 30;
          vidas = 3;
          marco150Ativado = true;
          modoAvancado = true;
        }
        if (!marco250Ativado && pontos >= 200) {
          tempo = 30;
          vidas = 3;
          marco250Ativado = true;
        }
        if (!marco350Ativado && pontos >= 300) {
          tempo = 20;
          vidas = 3;
          marco350Ativado = true;
        }
        if (jogoAtivo && millis() - ultimoTempoAtualizado >= 1000) {
          if (tempo > 0 && vidas > 0) {
            tempo--;
            ultimoTempoAtualizado = millis();
          }
        }

        let escalaCapivara = height * 0.16;
        let escalaItens = height * 0.12;
        let itemSize = escalaItens * 0.6;

        let imagemCapivaraFinal;
        if (pontos >= 300)
          imagemCapivaraFinal = arrastando ? capivaraMaePulando : capivaraMae;
        else if (pontos >= 200)
          imagemCapivaraFinal = arrastando ? capivaraPaiPulando : capivaraPai;
        else if (modoAvancado)
          imagemCapivaraFinal = arrastando
            ? capivaraSurfistaPulando
            : capivaraSurfista;
        else imagemCapivaraFinal = capivaraAtual;

        image(
          imagemCapivaraFinal,
          capivaraX - escalaCapivara / 2,
          height - escalaCapivara - 20,
          escalaCapivara,
          escalaCapivara
        );

        if (!isMobile) {
          if (keyIsDown(LEFT_ARROW)) capivaraX -= 5;
          if (keyIsDown(RIGHT_ARROW)) capivaraX += 5;
        }
        capivaraX = constrain(capivaraX, 0, width);

        frameContador++;
        let aumentoFrequencia = 1 + Math.floor(pontos / 50) * 0.2;
        let intervalo = Math.floor((isMobile ? 180 : 140) / aumentoFrequencia);

        if (jogoAtivo && frameContador % intervalo === 0) gerarItem();

        let baseVelocidade = isMobile ? 2 : 3;
        if (isIphone) baseVelocidade *= 1.4;
        let velocidade = baseVelocidade * (1 + 0.1 * velocidadeBonus);

        for (let i = pedras.length - 1; i >= 0; i--) {
          let p = pedras[i];
          image(pedraImg, p.x, p.y, itemSize, itemSize);
          if (jogoAtivo) p.y += velocidade;

          let distancia = dist(
            p.x + itemSize / 2,
            p.y + itemSize / 2,
            capivaraX,
            height - itemSize / 2 - 20
          );

          if (jogoAtivo && distancia < itemSize) {
            vidas--;
            pedras.splice(i, 1);
          } else if (p.y > height) {
            pedras.splice(i, 1);
          }
        }
        for (let i = boias.length - 1; i >= 0; i--) {
          let b = boias[i];
          image(b.tipo, b.x, b.y, itemSize, itemSize);
          if (jogoAtivo) b.y += velocidade;

          if (
            dist(b.x, b.y, capivaraX, height - itemSize / 2 - 20) < itemSize
          ) {
            if (!jogoAtivo) continue;

            if (b.tipo === boiaLaranja || b.tipo === boiaAzul) tempo += 2;
            pontos += 5;
            boias.splice(i, 1);
          } else if (b.y > height) {
            boias.splice(i, 1);
          }
        }

        if (vidas > 0 && tempo > 0) {
          let textSizeVal = height * 0.03;
          let lineHeight = textSizeVal * 1.2;
          fill(255);
          stroke(0, 128);
          strokeWeight(1.4);
          textSize(textSizeVal);
          textAlign(LEFT, TOP);
          textStyle(BOLD);
          text(`⏱️ Tempo: ${tempo}`, 20, 20);
          text(`❤️ Vidas: ${vidas}`, 20, 20 + lineHeight);
          text(`⭐ Pontos: ${pontos}`, 20, 20 + lineHeight * 2);
          noStroke();
        }

        if (vidas <= 0 || tempo <= 0) {
          jogoAtivo = false;
          fill(0, 0, 0, 102);
          rect(0, 0, width, height);
          let centerX = width / 2;
          let centerY = height / 2;
          let imgW = isMobile ? width * 0.98 : width * 0.6;
          let imgH = imgW * (gameOverImg.height / gameOverImg.width);
          if (isMobile && imgH < height * 0.2) {
            imgH = height * 0.2;
            imgW = imgH * (gameOverImg.width / gameOverImg.height);
          }
          image(
            gameOverImg,
            centerX - imgW / 2,
            centerY - imgH / 2 - 120,
            imgW,
            imgH
          );
          textAlign(CENTER, CENTER);
          textSize(height * 0.05);
          fill(255);
          stroke(0);
          strokeWeight(1.4);
          textStyle(BOLD);
          text(`⭐ Pontos: ${pontos}`, centerX, centerY);
          noStroke();

          let iconSize = height * 0.08;
          let iconX = centerX - iconSize / 2;
          let iconY = centerY + 70;
          image(tryAgainIcon, iconX, iconY, iconSize, iconSize);
          textSize(height * 0.035);
          fill(255);
          stroke(0);
          strokeWeight(1);
          let textY = iconY + iconSize + 25;
          text("Tentar novamente", centerX, textY);
          noStroke();

          tryAgainArea = {
            x: iconX,
            y: iconY,
            w: iconSize,
            h: iconSize + 30,
            centerX: centerX,
            textY: textY,
            textSize: height * 0.035,
          };
        }
      }

      function gerarItem() {
        if (random() < 0.45) pedras.push({ x: random(width), y: 0 });
        else
          boias.push({
            x: random(width),
            y: 0,
            tipo: random([boiaLaranja, boiaAzul]),
          });
      }

      function touchMoved() {
        if (!jogoAtivo) return false;
        if (isMobile) {
          capivaraX = constrain(touches[0].x, 0, width);
          if (!arrastando) {
            capivaraAtual = capivaraStanding;
            arrastando = true;
          }
        }
        return false;
      }

      function mouseDragged() {
        if (!jogoAtivo) return false;
        if (!isMobile) {
          capivaraX = constrain(mouseX, 0, width);
          capivaraAtual = capivaraStanding;
          arrastando = true;
        }
        return false;
      }

      function touchEnded() {
        if (isMobile) {
          capivaraAtual = capivara;
          arrastando = false;
        }
      }

      function mouseReleased() {
        if (!isMobile) {
          capivaraAtual = capivara;
          arrastando = false;
        }
      }

      function reiniciarJogo() {
        velocidadeBonus = 0;
        vidas = 3;
        tempo = 40;
        pontos = 0;
        frameContador = 0;
        pedras = [];
        boias = [];
        modoAvancado = false;
        marco150Ativado = false;
        marco250Ativado = false;
        marco350Ativado = false;
        jogoAtivo = true;
      }
      function touchStarted() {
        userStartAudio();
        if (!musicaFundo.isPlaying()) {
          musicaFundo.loop();
        }
        if (navigator.vibrate) {
          navigator.vibrate(100);
        }
        if (isMobile) {
          capivaraAtual = capivaraStanding;
          arrastando = true;
        }
      }
      function mousePressed() {
        userStartAudio();
        if (!musicaFundo.isPlaying()) {
          musicaFundo.loop();
        }
        if ((vidas <= 0 || tempo <= 0) && tryAgainArea) {
          let mx = mouseX;
          let my = mouseY;
          let a = tryAgainArea;
          let iconHit =
            mx >= a.x && mx <= a.x + a.w && my >= a.y && my <= a.y + a.w;
          textSize(a.textSize);
          let textW = textWidth("Tentar novamente");
          let textH = a.textSize;
          let textHit =
            mx >= a.centerX - textW / 2 &&
            mx <= a.centerX + textW / 2 &&
            my >= a.textY - textH / 2 &&
            my <= a.textY + textH / 2;
          if (iconHit || textHit) reiniciarJogo();
        }
        return false;
      }
    </script>
  </body>
</html>
